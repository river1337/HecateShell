# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

HecateShell is a custom Wayland shell built with QuickShell/QML for Arch Linux running the Niri compositor. The project consists of two main components:

1. **QML Shell** (root directory): The actual shell UI with hot-reloadable configuration
2. **Go CLI** (`hecate-shell-src/`): Management binary for installation, theming, and wallpaper control

## Development Commands

### Building the CLI
```bash
cd hecate-shell-src
go build -o ../hecate .
```

### Running the Shell
```bash
# Start shell (requires installation first)
./hecate run

# Reload shell (kills existing instance and starts fresh)
./hecate run --reload
```

### Installing
```bash
# First time setup
./hecate install

# Force reinstall
./hecate install --force
```

### Theme Management
```bash
# Reload theme from theme.json
./hecate theme reload

# Set wallpaper with theme generation
./hecate wallpaper /path/to/image.jpg --generate-theme

# Set wallpaper with custom transition
./hecate wallpaper /path/to/image.jpg --transition fade --duration 2
```

### Updating
```bash
# Check for and pull updates
./hecate update

# Force update
./hecate update --force
```

### Manual Theme Generation
```bash
# From theme.json
matugen json ~/.config/HecateShell/theme.json -m dark --continue-on-error

# From wallpaper
matugen image ~/wallpaper.png -m dark --continue-on-error

# From color
matugen color '#D5C4AA' -m dark --continue-on-error
```

Note: `--continue-on-error` is required because matugen templates for other apps (rofi, micro) expect Material Design color names that may not exist.

## Architecture

### QML Shell Structure

```
shell.qml                    # Entry point - imports Niri, loads Bar
├── bar/Bar.qml             # Main bar container (left/center/right sections)
├── components/
│   ├── Workspaces.qml      # 5 workspace indicators with sliding animation
│   ├── DateWidget.qml      # Live-updating date display
│   ├── MusicVisualizer.qml # Real-time audio visualizer using cava
│   ├── TimeWidget.qml      # Live-updating time display
│   └── SystemWidgets.qml   # Audio (PipeWire) + WiFi (ping-based)
└── config/
    ├── Config.qml          # Singleton config with hot-reload (checks every 1s)
    ├── colors.conf         # Generated by matugen, auto-reloads
    ├── theme.conf          # Additional config (currently unused)
    └── cava.conf           # Audio visualizer configuration
```

### Go CLI Structure

```
hecate-shell-src/
├── main.go                 # Entry point
├── cmd/
│   ├── root.go            # Cobra root command setup
│   ├── install.go         # Clone repo to ~/.config/HecateShell
│   ├── run.go             # Launch QuickShell with --daemonize
│   ├── update.go          # Git pull + version checking
│   ├── theme.go           # Theme reload via matugen
│   └── wallpaper.go       # swww integration + theme generation
└── internal/
    ├── config/config.go   # Path helpers, version checking
    └── shell/shell.go     # QuickShell process management (pkill)
```

### Hot-Reload System

The shell uses a timer-based hot-reload mechanism (config/Config.qml:132-146):
- Every 1 second, reads `$HOME/.config/HecateShell/config/colors.conf`
- Compares content with last read
- If changed, parses and updates color properties
- All QML components reference `Config.` properties, so changes propagate immediately
- Paths are dynamically constructed using `Quickshell.env("HOME")` to work on any system

Color transitions are animated (200ms) across all widgets.

### Theme/Color Flow

1. Source colors stored in `theme.json` (Material Design 3 palette)
2. Matugen reads `theme.json` (or wallpaper/color input)
3. Matugen generates `$HOME/.config/HecateShell/config/colors.conf` from template
4. Config.qml hot-reloads `colors.conf` every 1 second (path dynamically resolved)
5. All widgets update via property bindings

Color mappings (defined in matugen template):
- `barBackground` → `surface`
- `backgroundColor` → `background`
- `backgroundColorAlt` → `surfaceContainer`
- `borderColor` → `outline`
- `textColor` → `surfaceText`
- `textColorDim` → `surfaceVariantText`
- `accentColor` → `primary`
- `workspaceActive` → `primary`
- `workspaceInactive` → `surfaceContainerHigh`
- `visualizerColor` → `primary`

### Audio Visualizer (MusicVisualizer.qml)

Uses `cava` with custom configuration:
- Frequency range: 50 Hz - 10 kHz
- Bars arranged: lows (left) → mids (center) → highs (right)
- Bars grow upward from bottom
- 20 bars total with 2px spacing
- Configuration in `config/cava.conf`

### Audio Control (SystemWidgets.qml)

PipeWire integration via `wpctl`:
- Click: toggle mute (between 0% and previous volume)
- Scroll: adjust volume (clamped 0-100%)
- Icon changes when muted (volume = 0%)

### Network Status (SystemWidgets.qml)

Ping-based connectivity check:
- Pings `1.1.1.1` to determine connection status
- Icon updates based on connectivity

### Workspaces (Workspaces.qml)

5 workspace indicators with:
- Sliding position indicator for active workspace
- Active workspace text fades to darker color
- Niri IPC integration for workspace state

## Key Technical Details

### QuickShell/Niri Integration

- Uses Niri QML module (imported as `Niri 0.1`)
- Shell connects to Niri compositor on startup
- Workspace state synchronized via Niri IPC

### CLI Installation Flow

1. `hecate install` clones repo from GitHub to `~/.config/HecateShell`
2. Checks for `shell.qml` to verify installation
3. `hecate run` launches QuickShell with config directory path
4. QuickShell runs with `--no-duplicate --daemonize` flags

### Update/Version System

- Version stored in `version` file (plain text)
- Remote version fetched from GitHub raw content
- Update compares versions, runs `git pull` if needed
- User can force update with `--force` flag

## Dependencies

Runtime:
- quickshell-git (Qt 6.10+, Niri support)
- cava (audio visualizer)
- pipewire + wireplumber (audio control)
- matugen (color generation)
- niri (Wayland compositor)
- swww (wallpaper daemon, for `hecate wallpaper` command)

Build (Go CLI):
- Go 1.25.4+
- github.com/spf13/cobra v1.10.2

## Common Patterns

### Adding New QML Components

1. Create component in appropriate directory (e.g., `components/MyWidget.qml`)
2. Add to `qmldir` if creating a new module
3. Import in parent component (e.g., `Bar.qml`)
4. Reference `Config.` properties for theming
5. Use `Behavior on color { ColorAnimation { duration: 200 } }` for smooth transitions

### Adding New CLI Commands

1. Create new file in `cmd/` (e.g., `cmd/mycommand.go`)
2. Define cobra.Command with Use/Short/Long/RunE
3. Add to rootCmd in `init()` function
4. Use `internal/config` for path helpers
5. Use `internal/shell` for QuickShell process management

### Modifying Color Scheme

- Edit `theme.json` with new Material Design 3 colors
- Run `hecate theme reload` or manually invoke matugen
- Shell updates automatically within 1 second

## Known Quirks

- QuickShell may be built against different Qt version than system (rebuild if needed)
- Matugen requires `--continue-on-error` due to other app templates expecting MD color names
- Hot-reload uses 1-second timer polling (could be improved with inotify)
- Repository URL hardcoded in `internal/config/config.go` as `river1337/HecateShell`
